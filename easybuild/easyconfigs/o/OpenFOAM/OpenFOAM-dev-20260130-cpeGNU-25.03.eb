#DOC Development version of OpenFOAM. Note that we only support released versions of software 
#DOC and no alpha, beta or development versions as people who use those should also have the
#DOC skills to build a package properly and debug it. Hence this EasyConfig is just given as
#DOC a template without any warranties.
#
# Version 10, based on instructions from Esko JÃ¤rvinen, CSC
# Updated to version 10 by Orian Louant
# Updated to version 12 by Stanislau Stasheuski
# Ported to dev version by Tor Skovsgaard (DeiC)

easyblock = 'Binary'

local_version_tag = '20260130'

name    = 'OpenFOAM'
version = f'dev-{local_version_tag}' # Stresses that this is the development version, shows which tag,
                                     # and they will be sorted in a nice order. Since the tag can also
                                     # be considered kind of a version, we include it in version rather 
                                     # than versionsuffix.

homepage = 'http://www.openfoam.org/'

whatis = [
    'Description: The OpenFOAM (CFD software) distribution from the OpenFOAM Foundation'
]

description = """
OpenFOAM is the leading free, open source software for computational fluid dynamics (CFD),
owned by the OpenFOAM Foundation and distributed exclusively under the General Public Licence (GPL).
The GPL gives users the freedom to modify and redistribute the software and a guarantee of continued
free use, within the terms of the licence.
"""

usage = """
To run OpenFOAM solvers on compute nodes use srun command:

 srun foamSolverName -parallel

in either job script for sbatch or directly within salloc session.

Allrun scripts require some additional tweaking.
"""

toolchain = {'name': 'cpeGNU', 'version': '25.03'}

sources     = [
    {
        'filename':          'OpenFOAM-%(versionsuffix)s.tar.gz',
        'download_filename': f'{local_version_tag}.tar.gz' ,
        'source_urls':       ['https://github.com/OpenFOAM/OpenFOAM-dev/archive/refs/tags']
    }]
patches = [
    ('wmake-rules-linux64Cray-gcc13.patch', 0),
]

builddependencies = [
    ('buildtools', '%(toolchain_version)s', '', True),
]

# Note that there may be something wrong with these dependencies as METIS comes in twice in a 
# different version: According to EasyBuild, OpenFOAM needs the -idx32-fp64 version of METIS,
# but METIS also comes in through Zoltan in its -idx32-fp32 version.
dependencies = [
    ('cray-fftw', EXTERNAL_MODULE),
    ('SCOTCH',    '7.0.8'),
    ('METIS',     '5.1.0', '-idx32-fp64'), # To correspond with WM_LABEL_SIZE (for idx) and WM_PRECISION_OPTION (for fp) in etc/bashrc
    ('Zoltan',    '3.901'), # depends on ParMETIS
]

unpack_options    = '--strip-components=1'
extract_sources   = True
buildininstalldir = True

local_project_name = '%(version)s-%(toolchain_name)s-%(toolchain_version)s'

install_cmd  = ' && '.join([
    f'./bin/tools/foamConfigurePaths --projectName {local_project_name} --dependency PARMETIS=OpenFOAM --dependency ParaView=none',
    'printf "export PARMETIS_ARCH_PATH=$EBROOTPARMETIS\nexport PARMETIS_VERSION=parmetis-${EBVERSIONPARMETIS}\n" > ./etc/config.sh/parMetis',
    'sed -i \'125i    *cpeGNU*) version=%(version)s ;;\' ./bin/foamEtcFile',
    'source ./etc/bashrc WM_COMPILER=Cray WM_CC=cc WM_CXX=CC WM_MPLIB=CRAY-MPICH MPICH_DIR=${CRAY_MPICH_PREFIX}',
    './Allwmake -j%(parallel)s',
])

sanity_check_paths = {
    'files': [],
    'dirs':  ['platforms/linux64CrayDPInt32Opt/bin', 'platforms/linux64CrayDPInt32Opt/lib'],
}

modextravars = {
    'FOAM_BASH'       : '%(installdir)s/bashrc',
    'MPI_BUFFER_SIZE' : '2000000000',
}

# source_sh fails, use execute as workaround
modluafooter = """
execute {cmd="source " .. pathJoin(root, "etc/bashrc") .. " WM_COMPILER=Cray WM_MPLIB=CRAY-MPICH WM_CC=gcc-13 WM_CXX=g++-13", modeA={"load"}}
"""

moduleclass = 'cae'
